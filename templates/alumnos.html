{% extends "base.html" %}
{% block title %}Alumnos — Mi Mentor de Inversión{% endblock %}

{% block head %}
<style>
  .page-header h4 { margin: 0; }
  .badge-gen { background: #f6f7f9; border: 1px solid #e5e7eb; color:#111827; }
  .table thead th { white-space: nowrap; }
  .text-truncate-220 { max-width: 220px; display:inline-block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
</style>
{% endblock %}

{% block content %}

<!-- Encabezado -->
<div class="d-flex align-items-center justify-content-between mb-3 page-header">
  <div>
    <h4 class="fw-semibold">Alumnos</h4>
    <div class="text-muted small">Vista general y acceso rápido al panel del alumno</div>
  </div>
  <div class="d-flex gap-2 align-items-center">
    <span class="badge text-bg-light" id="totalBadge">—</span>
    <button id="exportExcelBtn" class="btn btn-outline-success btn-sm">
      <i class="bi bi-file-earmark-excel"></i> Exportar Excel
    </button>
  </div>
</div>

<!-- Filtros -->
<div class="card shadow-sm mb-3">
  <div class="card-body">
    <form id="filterForm" class="row g-3 align-items-end">
      <div class="col-md-4">
        <label for="generacion" class="form-label">Generación</label>
        <select class="form-select" id="generacion">
          <option value="">Todas</option>
        </select>
      </div>
      <div class="col-md-4">
        <label for="correo" class="form-label">Correo</label>
        <input type="email" class="form-control" id="correo" placeholder="Ej. nombre@dominio.com">
      </div>
      <div class="col-md-4 d-flex gap-2">
        <button type="submit" class="btn btn-primary flex-fill">
          <i class="bi bi-search"></i> Buscar
        </button>
        <button type="button" class="btn btn-secondary flex-fill" id="limpiarFiltros">
          <i class="bi bi-eraser"></i> Limpiar
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Tabla -->
<div class="card">
  <div class="card-body">
    <div class="table-responsive" id="tablaAlumnos"></div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Encabezados visibles y orden
const headersAmigables = {
  "ID_ALUMNO": "ID Alumno",
  "NOMBRE_ALUMNO": "Nombre",
  "CORREO": "Correo",
  "TELEFONO": "Teléfono",
  "GASTO": "Gasto",
  "INGRESO": "Ingreso",
  "GENERACION_PROGRAMA": "Generación",
  "FECHA_INSCRIPCION": "Fecha inscripción",
  "FUENTE": "Fuente"
};

const mxnFmt = new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' });
const currencyFields = new Set(["PRECIO_GENERACION", "GASTO", "INGRESO"]);

function soloFecha(iso) {
  if (!iso) return "";
  const d = new Date(iso);
  if (isNaN(d)) return iso;
  return d.toISOString().split('T')[0];
}

function badgeGeneracion(val) {
  if (!val) return "";
  // Si vienen varias generaciones separadas por coma, muestra la primera + contador
  const parts = String(val).split(',').map(s => s.trim()).filter(Boolean);
  if (parts.length === 0) return "";
  let html = `<span class="badge badge-gen me-1">${parts[0]}</span>`;
  if (parts.length > 1) html += `<span class="badge text-bg-light">+${parts.length-1}</span>`;
  return html;
}

function cargarAlumnos(filtros = {}) {
  $('#tablaAlumnos').html('<div class="text-center text-muted py-4"><div class="spinner-border text-primary" role="status"></div><div class="mt-2">Cargando alumnos…</div></div>');

  $.ajax({
    url: "/api/alumnos",
    method: "GET",
    data: filtros,
    success: function (data) {
      const total = Array.isArray(data) ? data.length : 0;
      $('#totalBadge').text(`${total.toLocaleString('es-MX')} registros`);

      if (!Array.isArray(data) || data.length === 0) {
        $('#tablaAlumnos').html('<div class="alert alert-warning mb-0">No se encontraron alumnos.</div>');
        return;
      }

      // Construir THEAD
      const cols = Object.keys(headersAmigables);
      let thead = '<thead><tr>';
      cols.forEach(col => { thead += `<th>${headersAmigables[col]}</th>`; });
      thead += '<th>Acción</th></tr></thead>';

      // Construir TBODY
      let tbody = '<tbody>';
      data.forEach(row => {
        tbody += '<tr>';
        cols.forEach(col => {
          let raw = row[col] ?? '';
          // Fecha
          if (col.includes('FECHA')) raw = soloFecha(raw);

          // Moneda
          if (currencyFields.has(col)) {
            const num = Number(row[col]);
            if (!isNaN(num)) {
              const pretty = mxnFmt.format(num);
              tbody += `<td class="text-end" data-order="${num}">${pretty}</td>`;
              return;
            } else {
              tbody += `<td class="text-end" data-order=""></td>`;
              return;
            }
          }

          // Generación como badges
          if (col === 'GENERACION_PROGRAMA') {
            tbody += `<td>${badgeGeneracion(raw)}</td>`;
            return;
          }

          // Correo truncado para no romper en móvil
          if (col === 'CORREO') {
            tbody += `<td><span class="text-truncate-220" title="${raw}">${raw}</span></td>`;
            return;
          }

          tbody += `<td>${raw}</td>`;
        });

        const correo = row.CORREO || '';
        const tel = row.TELEFONO || '';
        const wa = 'https://wa.me/' + (String(tel).replace(/\D/g,'').length === 10 ? '52'+String(tel).replace(/\D/g,'') : String(tel).replace(/\D/g,'')) + '?text=' + encodeURIComponent(`Hola ${row.NOMBRE_ALUMNO || ''}, te saluda el equipo de Mi Mentor de Inversión. ¿Tienes 2 minutos?`);
        tbody += `<td class="text-nowrap">
          <a href="/alumno/${correo}" class="btn btn-info btn-sm me-1"><i class="bi bi-person-lines-fill"></i> Panel</a>
          <a href="${wa}" target="_blank" rel="noopener" class="btn btn-success btn-sm"><i class="bi bi-whatsapp"></i></a>
        </td>`;
        tbody += '</tr>';
      });
      tbody += '</tbody>';

      const html = `<table id="alumnosTable" class="table table-sm table-hover table-striped align-middle text-nowrap w-100">${thead}${tbody}</table>`;
      $('#tablaAlumnos').html(html);

      // DataTables
      const dt = $('#alumnosTable').DataTable({
        scrollX: true,
        pageLength: 50,
        lengthMenu: [[25, 50, 100], [25, 50, 100]],
        autoWidth: false,
        fixedHeader: true,
        dom: '<"d-flex justify-content-between align-items-center mb-2"lf>rt<"d-flex justify-content-between mt-2"ip><"dt-hidden-buttons"B>',
        buttons: [
          // botón excel oculto; usamos el botón propio arriba
          { extend: 'excelHtml5', title: 'alumnos', className: 'd-none', exportOptions: { columns: ':visible' } }
        ],
        order: [[0, 'asc']],
        language: {
          search: "Buscar:",
          lengthMenu: "Mostrar _MENU_",
          zeroRecords: "No se encontraron resultados",
          info: "Mostrando _START_ a _END_ de _TOTAL_",
          infoEmpty: "Mostrando 0 a 0 de 0",
          infoFiltered: "(filtrado de _MAX_ en total)",
          paginate: { first: "Primero", last: "Último", next: "Siguiente", previous: "Anterior" }
        },
        initComplete: function () { this.api().columns.adjust(); }
      });

      // Botón export (dispara el excel oculto)
      $('#exportExcelBtn').off('click').on('click', function(){
        dt.button('.buttons-excel').trigger();
      });
    },
    error: function (err) {
      console.error("Error al cargar alumnos:", err);
      $('#tablaAlumnos').html('<div class="alert alert-danger mb-0">Error al cargar datos.</div>');
    }
  });
}

$(function () {
  // Carga inicial
  cargarAlumnos();

  // Buscar
  $('#filterForm').on('submit', function (e) {
    e.preventDefault();
    cargarAlumnos({
      generacion: $('#generacion').val(),
      correo: $('#correo').val()
    });
  });

  // Limpiar
  $('#limpiarFiltros').on('click', function () {
    $('#filterForm')[0].reset();
    cargarAlumnos();
  });

  // Poblar generaciones
  $.get('/api/generaciones', function (gens) {
    (gens || []).forEach(g => $('#generacion').append(`<option value="${(g||'').trim()}">${g}</option>`));
  });
});
</script>
{% endblock %}
