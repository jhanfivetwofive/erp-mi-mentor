{% extends "base.html" %}

{% block title %}Alumnos - Mi Mentor de Inversi贸n{% endblock %}

{% block content %}

<!--  Encabezado -->
<div class="card shadow-sm mb-4">
    <div class="card-header bg-success text-white">
        <h4 class="mb-0"><i class="bi bi-boxes me-2"></i>Alumnos - Mi Mentor de Inversi贸n</h4>
    </div>
</div>

<!--  Filtros -->
<div class="card shadow-sm mb-4">
    <div class="card-body">
        <form id="filterForm" class="row align-items-end">
            <div class="col-md-4">
                <label for="generacion" class="form-label">Generaci贸n</label>
                <select class="form-select" id="generacion">
                    <option value="">Todas</option>
                </select>
            </div>
            <div class="col-md-4">
                <label for="correo" class="form-label">Correo</label>
                <input type="email" class="form-control" id="correo" placeholder="Ej. jonathan@fivetwofive.mx">
            </div>
            <div class="col-md-4 d-flex gap-2 mt-3 mt-md-0">
                <button type="submit" class="btn btn-primary flex-fill"><i class="bi bi-search"></i> Buscar</button>
                <button type="button" class="btn btn-secondary flex-fill" id="limpiarFiltros"><i class="bi bi-eraser"></i> Limpiar</button>
            </div>
        </form>
    </div>
</div>

<!--  Bot贸n de exportaci贸n -->
<div class="d-flex justify-content-end mb-3">
    <button id="exportExcelBtn" class="btn btn-outline-success"><i class="bi bi-file-earmark-excel"></i> Exportar a Excel</button>
</div>

<!--  Tabla AJAX -->
<div class="table-responsive" id="tablaAlumnos" style="overflow-x:auto; min-width:100%;"></div>

{% endblock %}

{% block scripts %}
<script>
// Diccionario de encabezados amigables
const headersAmigables = {
    "ID_ALUMNO": "ID Alumno",
    "NOMBRE_ALUMNO": "Nombre",
    "CORREO": "Correo",
    "TELEFONO": "Tel茅fono",
    "GASTO": "Gasto",
    "INGRESO": "Ingreso",
    "GENERACION_PROGRAMA": "Generaci贸n Programa",
    "FECHA_INSCRIPCION": "Fecha de Inscripci贸n",
    "FUENTE": "Fuente"
};

//  Formateador MXN (es-MX)
const mxnFmt = new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' });
// Campos que van como moneda
const currencyFields = new Set(["PRECIO_GENERACION", "GASTO", "INGRESO"]);  

function cargarAlumnos(filtros = {}) {
    $('#tablaAlumnos').html('<div class="text-center text-muted py-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Cargando...</span></div><br>Cargando alumnos...</div>');

    $.ajax({
        url: "/api/alumnos",
        method: "GET",
        data: filtros,
        success: function (data) {
            if (!Array.isArray(data) || data.length === 0) {
                $('#tablaAlumnos').html('<div class="alert alert-warning">No se encontraron alumnos.</div>');
                return;
            }

            let columnas = Object.keys(headersAmigables);
            let thead = '<thead><tr>' + columnas.map(col => `<th>${headersAmigables[col]}</th>`).join('') + '<th>Acci贸n</th></tr></thead>';


            let tbody = '<tbody>';
            data.forEach(row => {
                tbody += '<tr>';
                columnas.forEach(col => {
                    let valor = row[col] ?? '';

                    // Formato fecha yyyy-mm-dd (si aplica)
                    if (col.includes("FECHA") && valor) {
                        let fecha = new Date(valor);
                        if (!isNaN(fecha)) {
                            valor = fecha.toISOString().split('T')[0];
                        }
                    }
                    //  Formato moneda MXN (y orden num茅rico correcto)
                    if (currencyFields.has(col)) {
                        const num = Number(row[col]);
                        if (!isNaN(num)) {
                            const pretty = mxnFmt.format(num);
                            tbody += `<td class="text-end" data-order="${num}">${pretty}</td>`;
                        } else {
                            tbody += `<td class="text-end" data-order=""> </td>`;
                        }
                    } else {
                        tbody += `<td>${valor}</td>`;
                    }
                });
                tbody += `<td><a href="/alumno/${row.CORREO}" class="btn btn-info btn-sm"><i class="bi bi-person-lines-fill"></i> Ver Panel</a></td>`;
                tbody += '</tr>';
            });
            tbody += '</tbody>';

            const tableHTML = `<table id="alumnosTable" class="table table-sm table-hover table-striped table-bordered align-middle text-nowrap">${thead}${tbody}</table>`;
            $('#tablaAlumnos').html(tableHTML);

            $('#alumnosTable').DataTable({
                scrollX: true,
                scrollY: '400px',
                scrollCollapse: true,
                pageLength: 50,
                lengthMenu: [[25, 50, 100], [25, 50, 100]],
                autoWidth: false,
                responsive: false,
                dom: '<"d-flex justify-content-between align-items-center mb-2"lfB>rt<"d-flex justify-content-between mt-2"ip>',
                buttons: ['copy', 'csv', 'excel', 'pdf', 'print'],
                order: [[0, 'asc']],
                language: {
                    search: "Buscar:",
                    lengthMenu: "Mostrar _MENU_ registros",
                    zeroRecords: "No se encontraron resultados",
                    info: "Mostrando _START_ a _END_ de _TOTAL_ registros",
                    infoEmpty: "Mostrando 0 a 0 de 0 registros",
                    infoFiltered: "(filtrado de _MAX_ registros totales)",
                    paginate: {
                        first: "Primero", last: "ltimo", next: "Siguiente", previous: "Anterior"
                    }
                },
                initComplete: function () {
                    this.api().columns.adjust();
                }
            });

            $('#exportExcelBtn').on('click', function () {
                $('#alumnosTable').DataTable().button('.buttons-excel').trigger();
            });
        },
        error: function (err) {
            $('#tablaAlumnos').html('<div class="alert alert-danger">Error al cargar datos.</div>');
            console.error("Error al cargar alumnos:", err);
        }
    });
}

$(document).ready(function () {
    cargarAlumnos();

    $('#filterForm').on('submit', function (e) {
        e.preventDefault();
        cargarAlumnos({
            generacion: $('#generacion').val(),
            correo: $('#correo').val()
        });
    });

    $('#limpiarFiltros').on('click', function () {
        $('#filterForm')[0].reset();
        cargarAlumnos();
    });

    $.ajax({
        url: '/api/generaciones',
        method: 'GET',
        success: function (data) {
            data.forEach(gen => $('#generacion').append(`<option value="${gen.trim()}">${gen}</option>`));
        }
    });
});
</script>
{% endblock %}
