{% extends "base.html" %}
{% block title %}Panel de Alumno - Mi Mentor{% endblock %}

{% block content %}

{% if not alumno_info %}
  <div class="alert alert-warning">No se encontró información para este alumno.</div>
{% else %}

  {# ========= HEADER: DATOS PRINCIPALES + ACCIONES ========= #}
  {% set _parts = (alumno_info.NOMBRE_ALUMNO or '').split() %}
  {% set _ini = (( _parts[0][:1] if _parts|length>0 else '' ) ~ ( _parts[1][:1] if _parts|length>1 else '' ))|upper %}
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
        <div class="d-flex align-items-center gap-3">
          <div class="rounded-circle d-flex align-items-center justify-content-center"
               style="width:52px;height:52px;background:#eef5f0;border:1px solid #d7eee0;font-weight:600;">
            {{ _ini or 'AL' }}
          </div>
          <div>
            <h3 class="mb-0">{{ alumno_info.NOMBRE_ALUMNO or '—' }}</h3>
            <div class="text-muted small">ID: {{ alumno_info.ID_ALUMNO or '—' }}</div>
          </div>
        </div>

        <div class="d-flex flex-wrap gap-2 ms-auto">
          {% if alumno_info.CORREO %}
            <a class="btn btn-outline-primary" href="mailto:{{ alumno_info.CORREO }}">
              <i class="bi bi-envelope-at me-1"></i>Correo
            </a>
          {% endif %}
          {% if whatsapp_url %}
            <a class="btn btn-success" href="{{ whatsapp_url }}" target="_blank" rel="noopener">
              <i class="bi bi-whatsapp me-1"></i> WhatsApp
            </a>
          {% endif %}

          {# Botón a Insights de Adquisición (solo adquisicion/admin) #}
          {% set gen_default = (alumno_info.GENERACION_PROGRAMA or '').split(',')[0].strip() %}
          {% if rol_usuario|default('', true)|lower in ['adquisicion','admin'] %}
            <a class="btn btn-outline-success"
               href="{{ url_for('adquisicion_insights', gen=gen_default) if gen_default else url_for('adquisicion_insights') }}">
              <i class="bi bi-bullseye me-1"></i> Insights
            </a>
          {% endif %}

          <button id="btnCsv" class="btn btn-outline-secondary">
            <i class="bi bi-filetype-csv me-1"></i>CSV
          </button>
          <button id="btnTxt" class="btn btn-outline-secondary">
            <i class="bi bi-filetype-txt me-1"></i>TXT
          </button>
          <a class="btn btn-outline-secondary" href="{{ back_url() }}">
            <i class="bi bi-arrow-left me-1"></i> Volver
          </a>
        </div>
      </div>

      <div class="row g-3 mt-3">
        <div class="col-md-3">
          <div class="small text-muted">Correo</div>
          {% if alumno_info.CORREO %}
            <div><a href="mailto:{{ alumno_info.CORREO }}">{{ alumno_info.CORREO }}</a></div>
          {% else %}
            <div class="text-muted">—</div>
          {% endif %}
        </div>
        <div class="col-md-3">
          <div class="small text-muted">Teléfono</div>
          {% if alumno_info.TELEFONO %}
            <div><a href="tel:{{ alumno_info.TELEFONO }}">{{ alumno_info.TELEFONO }}</a></div>
          {% else %}
            <div class="text-muted">—</div>
          {% endif %}
        </div>
        <div class="col-md-3">
          <div class="small text-muted">Fecha de inscripción</div>
          <div>{{ (alumno_info.FECHA_INSCRIPCION|string)[:10] if alumno_info.FECHA_INSCRIPCION else '—' }}</div>
        </div>
        <div class="col-md-3">
          <div class="small text-muted">Generación(es)</div>
          <div class="text-truncate" title="{{ alumno_info.GENERACION_PROGRAMA or '' }}">
            {{ alumno_info.GENERACION_PROGRAMA or '—' }}
          </div>
        </div>
      </div>
    </div>
  </div>

  {# ========= RESUMEN ECONÓMICO ========= #}
  {% set gasto = alumno_info.GASTO or 0 %}
  {% set ingreso = alumno_info.INGRESO or 0 %}
  {% set saldo = ingreso - gasto %}
  {% set saldo_cls = 'text-success' if saldo>0 else ('text-danger' if saldo<0 else 'text-muted') %}
  {% set puede_mostrar_invertido = rol_usuario|default('', true)|lower in ['admin','postventa','adquisicion'] %}
  {% set col = 'col-md-3' if puede_mostrar_invertido else 'col-md-4' %}
  {% set invertido = alumno_info.MONTO_INVERTIDO_CURSOS or 0 %}

  <div class="card shadow-sm mb-4">
    <div class="card-header bg-white border-0">
      <h5 class="mb-0 d-flex align-items-center">
        <i class="bi bi-graph-up-arrow text-success me-2"></i> Resumen económico
      </h5>
    </div>
    <div class="card-body">
      <div class="row g-3">
        <div class="{{ col }}">
          <div class="stat-tile h-100">
            <div class="stat-icon"><i class="bi bi-cash-coin"></i></div>
            <div class="stat-label">Gasto acumulado</div>
            <div class="stat-value">{{ gasto | mxn }}</div>
          </div>
        </div>
        <div class="{{ col }}">
          <div class="stat-tile h-100">
            <div class="stat-icon"><i class="bi bi-wallet2"></i></div>
            <div class="stat-label">Ingreso acumulado</div>
            <div class="stat-value">{{ ingreso | mxn }}</div>
          </div>
        </div>
        <div class="{{ col }}">
          <div class="stat-tile h-100">
            <div class="stat-icon"><i class="bi bi-balance-scale"></i></div>
            <div class="stat-label">Saldo (Ingreso − Gasto)</div>
            <div class="stat-value {{ saldo_cls }}">{{ saldo | mxn }}</div>
          </div>
        </div>

        {% if puede_mostrar_invertido %}
        <div class="{{ col }}">
          <div class="stat-tile h-100">
            <div class="stat-icon"><i class="bi bi-mortarboard"></i></div>
            <div class="stat-label">Monto invertido en cursos</div>
            <div class="stat-value">{{ invertido | mxn }}</div>
            <small class="text-muted">Visible para Adquisición/Postventa/Admin</small>
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  {# ========= PARTICIPACIÓN ========= #}
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-white border-0">
      <h5 class="mb-0 d-flex align-items-center">
        <i class="bi bi-people text-success me-2"></i> Participación
      </h5>
    </div>
    <div class="card-body">
      <div class="row g-3">
        <div class="col-12">
          <div class="mb-1 fw-semibold small text-uppercase text-muted">Programas</div>
          <div>
            {% set programas = (alumno_info.PROGRAMA or '') %}
            {% for p in programas.split(', ') if p %}
              <span class="chip chip-success me-1 mb-1">{{ p }}</span>
            {% else %}
              <span class="text-muted">Sin programas</span>
            {% endfor %}
          </div>
        </div>

        <div class="col-12">
          <div class="mb-1 fw-semibold small text-uppercase text-muted">Generaciones</div>
          <div>
            {% set gens = (alumno_info.GENERACION_PROGRAMA or '') %}
            {% for g in gens.split(', ') if g %}
              <span class="chip chip-secondary me-1 mb-1">{{ g }}</span>
            {% else %}
              <span class="text-muted">Sin generaciones</span>
            {% endfor %}
          </div>
        </div>

        {% if alumno_info.FUENTE %}
        <div class="col-12">
          <div class="mt-2 small text-muted">
            <i class="bi bi-diagram-3 me-1"></i>Fuente: <strong class="text-body">{{ alumno_info.FUENTE }}</strong>
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  {# ======== INSIGHTS DE COMUNIDAD (admin/comunidad) ======== #}
  {% if rol_usuario|default('', true)|lower in ['admin','comunidad'] %}
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-success text-white d-flex align-items-center">
        <h4 class="mb-0"><i class="bi bi-lightbulb me-2"></i>Insights de Comunidad</h4>
      </div>
      <div class="card-body">
        <div class="row g-3 mb-3">
          <div class="col-md-3">
            <div class="card shadow-sm h-100">
              <div class="card-body">
                <div class="fw-semibold">Monto Total</div>
                <div class="fs-4">
                  {% if comunidad %}{{ comunidad.MONTO_INVERTIDO_TOTAL | mxn }}{% else %}-{% endif %}
                </div>
                <small class="text-muted">
                  {% if comunidad %}
                    Cursos: {{ comunidad.MONTO_INVERTIDO_CURSOS | mxn }} · Gala: {{ comunidad.MONTO_INVERTIDO_GALA | mxn }}
                  {% else %}Sin datos{% endif %}
                </small>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card shadow-sm h-100">
              <div class="card-body">
                <div class="fw-semibold">NPS</div>
                <div class="fs-4">{% if comunidad %}{{ comunidad.NPS_FINAL }}{% else %}-{% endif %}</div>
                <small class="text-muted">Calc 0–10: {% if comunidad %}{{ comunidad.CALIF_CALC_0_10 }}{% else %}-{% endif %}</small>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card shadow-sm h-100">
              <div class="card-body">
                <div class="fw-semibold">Cursos Thinkific</div>
                <div class="fs-4">{% if comunidad %}{{ comunidad.TOTAL_CURSOS or 0 }}{% else %}-{% endif %}</div>
                <small class="text-muted">% avance prom.: {% if comunidad %}{{ comunidad.PROMEDIO_AVANCE }}{% else %}-{% endif %}%</small>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card shadow-sm h-100">
              <div class="card-body">
                <div class="fw-semibold">Asistencias Webinar</div>
                <div class="fs-4">{% if comunidad %}{{ comunidad.TOTAL_ASISTENCIA_WEBINAR or 0 }}{% else %}-{% endif %}</div>
              </div>
            </div>
          </div>
        </div>

        <div class="mb-4">
          <h6 class="mb-2">Avance de Cursos</h6>
          {% if chart_labels and chart_labels|length > 0 %}
            <div style="height: 320px;"><canvas id="chartCursos"></canvas></div>
            <div class="text-muted small mt-2">Mostrando los {{ chart_labels|length }} cursos con mayor % de avance.</div>
          {% else %}
            <div class="text-muted small">Sin cursos registrados.</div>
          {% endif %}
        </div>

        <div class="row g-3">
          <div class="col-md-6">
            <div class="card shadow-sm h-100">
              <div class="card-body">
                <div class="fw-semibold mb-2">Comentarios de Encuestas</div>
                {% if comunidad and comunidad.COMENTARIOS %}
                  <ul class="small mb-0">
                    {% for c in comunidad.COMENTARIOS.split(' | ') %}
                      {% if c.strip() %}<li>{{ c }}</li>{% endif %}
                    {% endfor %}
                  </ul>
                {% else %}
                  <div class="text-muted small">Sin comentarios.</div>
                {% endif %}
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card shadow-sm h-100">
              <div class="card-body">
                <div class="fw-semibold mb-2">Calificaciones Promedio</div>
                {% if comunidad %}
                  <div class="small">
                    Expectativas: <strong>{{ comunidad.CALIF_EXPECTATIVAS }}</strong> ·
                    Temas: <strong>{{ comunidad.CALIF_TEMAS }}</strong> ·
                    Contenido: <strong>{{ comunidad.CALIF_CONTENIDO }}</strong> ·
                    Clase: <strong>{{ comunidad.CALIF_CLASE }}</strong>
                  </div>
                {% else %}
                  <div class="text-muted small">Sin calificaciones.</div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>

        <div class="row g-3 mt-2">
          <div class="col-12">
            <div class="card shadow-sm">
              <div class="card-body">
                <div class="fw-semibold mb-2">
                  Webinars asistidos
                  <span class="text-muted small">
                    (Total: {{ (comunidad.TOTAL_ASISTENCIA_WEBINAR or webinar_topics|length) if comunidad else (webinar_topics|length) }})
                  </span>
                </div>
                {% if webinar_topics and (webinar_topics|length > 0) %}
                  <div>
                    {% for t in webinar_topics[:50] %}
                      <span class="badge rounded-pill text-bg-secondary me-1 mb-1">{{ t }}</span>
                    {% endfor %}
                    {% if webinar_topics|length > 50 %}
                      <div class="small text-muted mt-2">y {{ webinar_topics|length - 50 }} más…</div>
                    {% endif %}
                  </div>
                {% else %}
                  <div class="text-muted small">Sin registros de webinars.</div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  {% endif %}

  {# ======== INSIGHTS DE POSTVENTA (postventa/admin) ======== #}
  {% if rol_usuario|default('',true)|lower in ['postventa','admin'] and postventa %}
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-success text-white d-flex align-items-center">
        <h4 class="mb-0"><i class="bi bi-cash-coin me-2"></i>Insights de Postventa</h4>
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-3">
            <div class="card h-100 shadow-sm">
              <div class="card-body">
                <div class="fw-semibold">Venta total (acum.)</div>
                <div class="fs-4">{{ postventa.VENTA_TOTAL_SUM | mxn }}</div>
                <small class="text-muted">Compras: {{ postventa.NUM_COMPRAS or 0 }}</small>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card h-100 shadow-sm">
              <div class="card-body">
                <div class="fw-semibold">Total pagado</div>
                <div class="fs-4">{{ postventa.TOTAL_PAGADO_SUM | mxn }}</div>
                <small class="text-muted">Forma de pago: {{ postventa.FORMA_DE_PAGO_ULT or '-' }}</small>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card h-100 shadow-sm">
              <div class="card-body">
                <div class="fw-semibold">Por cobrar</div>
                <div class="fs-4">{{ postventa.POR_COBRAR_SUM | mxn }}</div>
                <span class="badge {{ 'text-bg-success' if (postventa.ESTATUS_GLOBAL or '')=='PAGADO' else 'text-bg-warning' }}">
                  {{ (postventa.ESTATUS_GLOBAL or '-').replace('_',' ') }}
                </span>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card h-100 shadow-sm">
              <div class="card-body">
                <div class="fw-semibold">Última compra</div>
                <div class="fs-5">{{ (postventa.FECHA_COMPRA_ULTIMA|string)[:10] if postventa.FECHA_COMPRA_ULTIMA else '-' }}</div>
                <small class="text-muted">
                  INVINF: {{ postventa.GENERACION_INVINF_ULT or '-' }} · MP: {{ postventa.GENERACION_MP_ULT or '-' }}
                </small>
              </div>
            </div>
          </div>
        </div>

        {% if postventa.OBS_ULT %}
          <div class="mt-3">
            <div class="fw-semibold mb-1">Observaciones (últimas)</div>
            <div class="small">{{ postventa.OBS_ULT }}</div>
          </div>
        {% endif %}
      </div>
    </div>
  {% endif %}

  {# ======== SEGUIMIENTO (form) — postventa/admin ======== #}
  {% if rol_usuario|default('', true)|lower in ['postventa','admin'] %}
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-success text-white">
        <h4 class="mb-0"><i class="bi bi-clipboard-check me-2"></i>Seguimiento (Postventa)</h4>
      </div>
      <div class="card-body">
        <div id="alertSeg" class="alert d-none" role="alert"></div>
        <form id="formSeguimiento" class="row g-2">
          <input type="hidden" id="correo" value="{{ alumno_info.CORREO }}">
          <div class="col-md-3">
            <label class="form-label">Tipo</label>
            <select id="tipo" class="form-select" required>
              <option value="llamada">Llamada</option>
              <option value="whatsapp">WhatsApp</option>
              <option value="correo">Correo</option>
              <option value="otro">Otro</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">Estado</label>
            <select id="estado" class="form-select" required>
              <option value="contactado">Contactado</option>
              <option value="en_proceso">En proceso</option>
              <option value="cerrado">Cerrado</option>
            </select>
          </div>
          <div class="col-12">
            <label class="form-label">Nota</label>
            <textarea id="nota" class="form-control" rows="3" placeholder="Escribe el detalle de tu seguimiento..." required></textarea>
          </div>
          <div class="col-12 mt-2">
            <button type="submit" class="btn btn-success">
              <span class="spinner-border spinner-border-sm me-2 d-none" id="segSpinner" role="status" aria-hidden="true"></span>
              Guardar seguimiento
            </button>
          </div>
        </form>
      </div>
    </div>
  {% endif %}

  {# ======== HISTORIAL DE SEGUIMIENTO — postventa/admin ======== #}
  {% if rol_usuario|default('', true)|lower in ['postventa','admin'] %}
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-success text-white">
        <h4 class="mb-0"><i class="bi bi-clock-history me-2"></i>Historial de Seguimiento</h4>
      </div>
      <div class="card-body">
        {% if seguimientos and seguimientos|length > 0 %}
          <div class="list-group">
            {% for s in seguimientos %}
              <div class="list-group-item">
                <div class="d-flex justify-content-between">
                  <strong>{{ (s.TIPO or '')|upper }} · {{ (s.ESTADO or '')|upper }}</strong>
                  <small>{{ s.FECHA }}</small>
                </div>
                <div class="mt-1">{{ s.NOTA }}</div>
                <div class="mt-1 text-muted"><small>Por: {{ s.AUTOR }} ({{ s.ROL_AUTOR }})</small></div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <em>No hay seguimientos todavía.</em>
        {% endif %}
      </div>
    </div>
  {% endif %}

  {# ======== KANBAN — postventa/admin ======== #}
  {% if rol_usuario|default('',true)|lower in ['postventa','admin'] %}
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-success text-white">
        <h4 class="mb-0"><i class="bi bi-kanban me-2"></i>Seguimientos (Kanban)</h4>
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-4">
            <h6 class="text-muted mb-2">CONTACTADO</h6>
            <div id="col-contactado" class="kanban-col border rounded p-2" data-estado="contactado"></div>
          </div>
          <div class="col-md-4">
            <h6 class="text-muted mb-2">EN PROCESO</h6>
            <div id="col-enproceso" class="kanban-col border rounded p-2" data-estado="en_proceso"></div>
          </div>
          <div class="col-md-4">
            <h6 class="text-muted mb-2">CERRADO</h6>
            <div id="col-cerrado" class="kanban-col border rounded p-2" data-estado="cerrado"></div>
          </div>
        </div>
      </div>
    </div>

    <style>
      .kanban-col { min-height: 280px; background: #f8f9fa; }
      .kanban-card { background: white; border: 1px solid #dee2e6; border-radius: .5rem; padding: .5rem .75rem; margin-bottom: .5rem; cursor: grab; }
      .kanban-col.drag-over { outline: 2px dashed #198754; }
      .kanban-badge { font-size: .75rem; }
    </style>
  {% endif %}

{% endif %}

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  // Render de la gráfica de Thinkific (chartCursos)
  (function(){
    const labels = {{ (chart_labels or []) | tojson }};
    const values = {{ (chart_values or []) | tojson }};
    const el = document.getElementById('chartCursos');
    if (!el || !labels.length) return;

    new Chart(el.getContext('2d'), {
      type: 'bar',
      data: { labels, datasets: [{ label: '% completado', data: values, borderWidth: 1 }] },
      options: {
        indexAxis: 'y',
        responsive: true, maintainAspectRatio: false,
        scales: {
          x: { suggestedMin: 0, suggestedMax: 100, ticks: { callback: (v) => v + '%' } },
          y: { ticks: { autoSkip: false, maxTicksLimit: 20 } }
        },
        plugins: { legend: { display: false } }
      }
    });
  })();
</script>

<script>
(function () {
  const btnCsv = document.getElementById('btnCsv');
  const btnTxt = document.getElementById('btnTxt');
  if (!btnCsv && !btnTxt) return;

  const alumno = {{ alumno_info | tojson }};
  const cursos = {{ (cursos_info or []) | tojson }};
  const segs   = {{ (seguimientos or []) | tojson }};

  function dl(filename, mime, content) {
    const blob = new Blob([content], { type: mime });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename;
    document.body.appendChild(a); a.click();
    URL.revokeObjectURL(url); a.remove();
  }

  function toCsv(rows) {
    const esc = (v) => {
      const s = (v ?? '').toString();
      return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
    };
    return rows.map(r => r.map(esc).join(',')).join('\n');
  }

  function alumnoRows() {
    return [
      ['CAMPO','VALOR'],
      ['ID_ALUMNO', alumno.ID_ALUMNO || ''],
      ['NOMBRE_ALUMNO', alumno.NOMBRE_ALUMNO || ''],
      ['CORREO', alumno.CORREO || ''],
      ['TELEFONO', alumno.TELEFONO || ''],
      ['FECHA_INSCRIPCION', (alumno.FECHA_INSCRIPCION||'').toString().slice(0,10)],
      ['PROGRAMA', alumno.PROGRAMA || ''],
      ['GENERACION_PROGRAMA', alumno.GENERACION_PROGRAMA || ''],
      ['GASTO', alumno.GASTO ?? ''],
      ['INGRESO', alumno.INGRESO ?? ''],
      ['MONTO_INVERTIDO_CURSOS', alumno.MONTO_INVERTIDO_CURSOS ?? '']
    ];
  }

  function cursosRows() {
    if (!Array.isArray(cursos) || !cursos.length) return [];
    const head = [['COURSE_NAME','PERCENTAGE_COMPLETED','STARTED_AT','UPDATED_AT','COMPLETED_AT']];
    const body = cursos.map(c => [
      c.COURSE_NAME ?? '',
      c.PERCENTAGE_COMPLETED ?? '',
      c.STARTED_AT ?? '',
      c.UPDATED_AT ?? '',
      c.COMPLETED_AT ?? ''
    ]);
    return [[''],['SECCION','CURSOS']].concat(head, body);
  }

  function segRows() {
    if (!Array.isArray(segs) || !segs.length) return [];
    const head = [['ID','FECHA','TIPO','ESTADO','AUTOR','ROL_AUTOR','NOTA']];
    const body = segs.map(s => [
      s.ID ?? '',
      s.FECHA ?? '',
      s.TIPO ?? '',
      s.ESTADO ?? '',
      s.AUTOR ?? '',
      s.ROL_AUTOR ?? '',
      (s.NOTA ?? '').toString().replace(/\n/g,' ')
    ]);
    return [[''],['SECCION','SEGUIMIENTOS (últimos)']].concat(head, body);
  }

  function toTxt() {
    const lines = [];
    const fmt = (k,v) => `${k}: ${v ?? ''}`;
    lines.push(
      '=== ALUMNO ===',
      fmt('ID_ALUMNO', alumno.ID_ALUMNO),
      fmt('NOMBRE', alumno.NOMBRE_ALUMNO),
      fmt('CORREO', alumno.CORREO),
      fmt('TELEFONO', alumno.TELEFONO),
      fmt('FECHA_INSCRIPCION', (alumno.FECHA_INSCRIPCION||'').toString().slice(0,10)),
      fmt('PROGRAMA', alumno.PROGRAMA),
      fmt('GENERACION_PROGRAMA', alumno.GENERACION_PROGRAMA),
      '',
      '=== RESUMEN ECONÓMICO ===',
      fmt('GASTO', alumno.GASTO),
      fmt('INGRESO', alumno.INGRESO),
      fmt('MONTO_INVERTIDO_CURSOS', alumno.MONTO_INVERTIDO_CURSOS),
      fmt('SALDO (INGRESO - GASTO)', (alumno.INGRESO||0) - (alumno.GASTO||0))
    );
    if (Array.isArray(cursos) && cursos.length) {
      lines.push('', '=== CURSOS (Top N) ===');
      cursos.forEach(c => {
        lines.push(`- ${c.COURSE_NAME || '(sin nombre)'} | ${c.PERCENTAGE_COMPLETED ?? ''}% | upd: ${c.UPDATED_AT ?? ''}`);
      });
    }
    if (Array.isArray(segs) && segs.length) {
      lines.push('', '=== SEGUIMIENTOS ===');
      segs.forEach(s => {
        lines.push(`[${s.FECHA || ''}] ${ (s.TIPO||'').toUpperCase() } / ${ (s.ESTADO||'').toUpperCase() } — ${s.NOTA || ''} (por ${s.AUTOR || ''} - ${s.ROL_AUTOR || ''})`);
      });
    }
    return lines.join('\n');
  }

  btnCsv?.addEventListener('click', () => {
    const rows = []
      .concat(alumnoRows())
      .concat(cursosRows())
      .concat(segRows());
    const csv = toCsv(rows);
    const fname = `alumno_${(alumno.CORREO||'sin_correo').replace(/[^a-z0-9_.-]+/gi,'_')}.csv`;
    dl(fname, 'text/csv;charset=utf-8', csv);
  });

  btnTxt?.addEventListener('click', () => {
    const txt = toTxt();
    const fname = `alumno_${(alumno.CORREO||'sin_correo').replace(/[^a-z0-9_.-]+/gi,'_')}.txt`;
    dl(fname, 'text/plain;charset=utf-8', txt);
  });
})();
</script>
{% endblock %}
