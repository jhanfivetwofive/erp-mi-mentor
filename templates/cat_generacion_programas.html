{% extends "base.html" %}
{% block title %}Catálogo — Generaciones{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-success text-white">
      <h4 class="mb-0"><i class="bi bi-people-fill me-2"></i>Generaciones - Mi Mentor de Inversión</h4>
    </div>
  </div>

  <div class="table-responsive" id="tablaGeneraciones"></div>
</div>

<script>
  // Encabezados amigables
  const headersAmigables = {
    "ID_GENERACION_PROGRAMA": "ID Generación Programa",
    "PROGRAMA": "Programa",
    "GENERACION": "Generación",
    "GENERACION_ETIQUETA": "Etiqueta Generación",
    "FECHA_INICIO": "Fecha Inicio",
    "FECHA_FIN": "Fecha Fin",
    "PRECIO_GENERACION": "Precio Generación",
    "DESCRIPCION": "Descripción"
  };
</script>
{% endblock %}

{% block scripts %}
<script>
// Utilidades para inyectar CSS/JS si no existen todavía
function ensureCss(href) {
  if (![...document.styleSheets].some(s => s.href && s.href.includes(href))) {
    const l = document.createElement('link');
    l.rel = 'stylesheet'; l.href = 'https://' + href;
    document.head.appendChild(l);
  }
}
function ensureScript(src) {
  return new Promise((resolve, reject) => {
    if ([...document.scripts].some(s => s.src && s.src.includes(src))) return resolve();
    const el = document.createElement('script');
    el.src = src; el.onload = resolve; el.onerror = reject;
    document.body.appendChild(el);
  });
}

(async function init(){
  // CSS (por si base.html no lo trae)
  ensureCss('cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css');
  ensureCss('cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css');

  // jQuery + DataTables + Buttons (si no están)
  if (!(window.$ && window.jQuery)) {
    await ensureScript('https://code.jquery.com/jquery-3.7.1.min.js');
  }
  if (!(window.$ && $.fn && $.fn.DataTable)) {
    await ensureScript('https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js');
  }
  if (!(window.$ && $.fn && $.fn.dataTable && $.fn.dataTable.Buttons)) {
    await ensureScript('https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js');
    await ensureScript('https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js');
    await ensureScript('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/pdfmake.min.js');
    await ensureScript('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js');
    await ensureScript('https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js');
    await ensureScript('https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js');
  }

  cargarGeneraciones();
})();

function cargarGeneraciones() {
  $('#tablaGeneraciones').html(
    '<div class="text-center text-muted py-4">' +
      '<div class="spinner-border text-success" role="status"><span class="visually-hidden">Cargando...</span></div><br>' +
      'Cargando generaciones...' +
    '</div>'
  );

  $.ajax({
    url: "{{ url_for('api_generaciones') }}", // /api/catalogo/generaciones
    method: "GET",
    success: function(data) {
      if (!Array.isArray(data) || data.length === 0) {
        $('#tablaGeneraciones').html('<div class="alert alert-warning">No se encontraron generaciones.</div>');
        return;
      }

      const columnas = [
        "ID_GENERACION_PROGRAMA","PROGRAMA","GENERACION","GENERACION_ETIQUETA",
        "FECHA_INICIO","FECHA_FIN","PRECIO_GENERACION","DESCRIPCION"
      ];

      let thead = '<thead><tr>';
      columnas.forEach(col => thead += `<th>${headersAmigables[col] || col}</th>`);
      thead += '</tr></thead>';

      let tbody = '<tbody>';
      (data || []).forEach(row => {
        tbody += '<tr>';
        columnas.forEach(col => {
          let valor = row[col] ?? '';
          // Fechas: si backend te da 'YYYY-MM-DD' o 'No Disponible', muestra tal cual
          // (Si necesitas formatear, hazlo aquí)
          tbody += `<td>${valor}</td>`;
        });
        tbody += '</tr>';
      });
      tbody += '</tbody>';

      const tableHTML = `
        <table id="generacionesTable"
               class="table table-sm table-hover table-striped table-bordered align-middle text-nowrap w-100">
          ${thead}
          ${tbody}
        </table>`;

      if ($.fn.DataTable.isDataTable('#generacionesTable')) {
        $('#generacionesTable').DataTable().clear().destroy();
      }

      $('#tablaGeneraciones').html(tableHTML);

      $('#generacionesTable').DataTable({
        scrollX: true,
        scrollY: '400px',
        scrollCollapse: true,
        pageLength: 50,
        lengthMenu: [[25, 50, 100], [25, 50, 100]],
        autoWidth: false,
        responsive: false,
        dom: '<"d-flex justify-content-between align-items-center mb-2"lfB>rt<"d-flex justify-content-between mt-2"ip>',
        order: [[4, 'desc']], // FECHA_INICIO si viene consistente
        buttons: ['copy', 'csv', 'excel', 'pdf', 'print'],
        language: {
          search: "Buscar:",
          lengthMenu: "Mostrar _MENU_ registros por página",
          zeroRecords: "No se encontraron resultados",
          info: "Mostrando _START_ a _END_ de _TOTAL_ registros",
          infoEmpty: "Mostrando 0 a 0 de 0 registros",
          infoFiltered: "(filtrado de _MAX_ registros totales)",
          paginate: { first: "Primero", last: "Último", next: "Siguiente", previous: "Anterior" }
        },
        initComplete: function () { this.api().columns.adjust(); }
      });
    },
    error: function(err) {
      $('#tablaGeneraciones').html('<div class="alert alert-danger">Error al cargar datos.</div>');
      console.error("Error al cargar generaciones:", err);
    }
  });
}
</script>
{% endblock %}
