{% extends "base.html" %}
{% block title %}Diagnóstico Postventa — Listado{% endblock %}

{% block content %}
<div class="card shadow-sm">
  <div class="card-header bg-white border-0 py-3">
    <div class="d-flex align-items-center">
      <div>
        <h4 class="mb-0">Registros de Diagnóstico</h4>
        <small class="text-muted">Listado de capturas con calificación y viabilidad</small>
      </div>
      <a class="btn btn-success ms-auto" href="{{ url_for('postventa_diagnostico') }}">
        <i class="bi bi-plus-lg me-1"></i> Nuevo
      </a>
    </div>
  </div>

  <div class="card-body pt-0">
    <div class="table-responsive">
      <table id="tablaDiag" class="table table-hover align-middle w-100">
        <thead class="table-light">
          <tr>
            <th style="width:120px;">ID</th>
            <th style="width:160px;">Fecha</th>
            <th>Nombre</th>
            <th style="width:110px;">Generación</th>
            <th style="width:130px;">Calificación</th>
            <th style="width:140px;">Viabilidad</th>
            <th style="width:120px;">Venta</th>
            <th style="width:130px;">Teléfono</th>
            <th>Correo</th>
            <th style="width:170px;">Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for r in data %}
          {# Viabilidad desde la vista DM (más fiable) #}
          {% set vtxt = (r.ESTATUS_VIABLE or '') %}
          {% set vcolor = 'success' if vtxt == 'VIABLE'
          else 'warning' if vtxt == 'REQUIERE AJUSTE'
          else 'danger' if vtxt == 'NO VIABLE'
          else 'secondary' %}
          {% set es_venta = (r.ESTATUS_VENTA or 0)|int %}
          {% set fecha = r.FECHA_ENCUESTA %}
          <tr>
            {# antes de las celdas, resuelve variables seguras #}
            {% set id_val = r.ID_ENCUESTA or r.ID %}
            {% set fecha_val = r.FECHA_ENCUESTA or r.FECHA %}

            <td class="text-nowrap">
              <span class="badge bg-light text-dark fw-semibold font-monospace">{{ id_val }}</span>
            </td>
            {# Resuelve la fecha y pásala a texto YYYY-MM-DD #}
            {% set raw_fecha = r.FECHA_ENCUESTA or r.FECHA %}
            {% set fecha_txt = (raw_fecha|string)[:10] %}

            <td class="text-nowrap" data-order="{{ fecha_txt }}">
              {{ fecha_txt }}
            </td>
            <td>{{ r.NOMBRE }}</td>
            <td class="text-nowrap">{{ r.GENERACION }}</td>
            <td>
              <div class="d-flex align-items-center gap-2">
                <strong>{{ r.CALIFICACION }}</strong>
                <div class="progress flex-grow-1" style="height:8px; max-width:120px;">
                  <div class="progress-bar" role="progressbar"
                    style="width: {{ ((r.CALIFICACION or 0) / 33.0 * 100) | round(0) }}%;"></div>
                </div>
              </div>
            </td>
            <td>
              {% if vtxt %}
              <span class="badge bg-{{ vcolor }}">{{ vtxt }}</span>
              {% endif %}
            </td>
            <td>
              <span class="badge {{ 'bg-success' if es_venta == 1 else 'bg-secondary' }}">
                {{ venta_text(r.ESTATUS_VENTA) }}
              </span>
            </td>
            <td class="text-nowrap">
              {% set t = r.TELEFONO or '' %}
              {% if t %}
              <a href="tel:+52{{ to_whatsapp_e164(t)|replace('52','',1) }}"
                class="link-underline link-underline-opacity-0">
                {{ t }}
              </a>
              {% endif %}
            </td>
            <td class="text-nowrap">
              {% if r.CORREO %}
              <a href="mailto:{{ r.CORREO }}" class="link-underline link-underline-opacity-0">{{ r.CORREO }}</a>
              {% endif %}
            </td>
            <td class="text-nowrap d-flex gap-1">
              {% set wa = 'https://wa.me/' ~ to_whatsapp_e164(r.TELEFONO or '') ~ '?text=' ~ ('Hola ' ~ (r.NOMBRE or '')
              ~ ', soy de Mi Mentor. Gracias por tu diagnóstico. ¿Te comparto un plan de acción?')|urlencode %}
              <a class="btn btn-sm btn-success" href="{{ wa }}" target="_blank" rel="noopener">
                <i class="bi bi-whatsapp me-1"></i> WhatsApp
              </a>
              <button type="button" class="btn btn-sm btn-outline-primary btn-ver" data-bs-toggle="modal"
                data-bs-target="#modalRespuestas" data-reg='{{ r|tojson|safe }}'>
                <i class="bi bi-card-checklist me-1"></i> Respuestas
              </button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

{# Modal de respuestas #}
<div class="modal fade" id="modalRespuestas" tabindex="-1" aria-labelledby="modalRespuestasLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalRespuestasLabel">Respuestas del diagnóstico</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <div id="respMeta" class="mb-3 small text-muted"></div>
        <div id="respGrid" class="row row-cols-1 row-cols-md-2 g-3"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}
{% block scripts %}
{{ super() }}   {# <-- MUY IMPORTANTE: trae el JS del base.html #}

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // DataTable sin botones de exportación
    if (window.jQuery && $("#tablaDiag").DataTable) {
      $("#tablaDiag").DataTable({
        pageLength: 25,
        order: [[1, 'desc']],
        stateSave: true,
        fixedHeader: true,
        dom: '<"row align-items-center mb-3"<"col-sm-6"l><"col-sm-6 text-end"f>>' +
             't' +
             '<"row mt-3"<"col-sm-6"i><"col-sm-6 text-end"p>>',
        language: {
          lengthMenu: "Mostrar _MENU_ registros",
          search: "Buscar:",
          info: "Mostrando _START_–_END_ de _TOTAL_",
          infoEmpty: "Sin registros",
          infoFiltered: "(filtrado de _MAX_ en total)",
          zeroRecords: "No se encontraron coincidencias",
          paginate: { previous: "‹", next: "›" }
        }
      });
    }

    // Modal Respuestas…
    const modalEl = document.getElementById('modalRespuestas');
    modalEl.addEventListener('show.bs.modal', function (ev) {
      const btn = ev.relatedTarget;
      const raw = btn?.getAttribute('data-reg');
      if (!raw) return;
      const r = JSON.parse(raw);
      const id = r.ID_ENCUESTA ?? r.ID ?? '';
      const rawFecha = r.FECHA_ENCUESTA ?? r.FECHA ?? '';
      const fechaTxt = String(rawFecha).slice(0, 10);

      const meta = `
        <div><strong>ID:</strong> ${id} · <strong>Fecha:</strong> ${fechaTxt}</div>
        <div><strong>Nombre:</strong> ${r.NOMBRE ?? ''} · <strong>Generación:</strong> ${r.GENERACION ?? ''}</div>
        <div><strong>Calificación:</strong> ${r.CALIFICACION ?? ''} · <strong>Venta:</strong> ${r.ESTATUS_VENTA ?? ''}</div>
        <div><strong>Correo:</strong> ${r.CORREO ?? ''} · <strong>Teléfono:</strong> ${r.TELEFONO ?? ''}</div>
      `;
      document.getElementById('respMeta').innerHTML = meta;

      const keys = ["R1","R2","R3","R4","R5","R6","R7","R8","R9","R10","R11"];
      const grid = document.getElementById('respGrid');
      grid.innerHTML = "";

      for (const k of keys) {
        const val = r[k];
        const desc = r[`${k}_DESC`] || "";
        const col = document.createElement('div');
        col.className = 'col';
        col.innerHTML = `
          <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
              <span><strong>${k}</strong></span>
              <span class="badge bg-primary">${val ?? ''}</span>
            </div>
            <div class="card-body">
              <div>${desc}</div>
            </div>
          </div>
        `;
        grid.appendChild(col);
      }
    });
  });
</script>
{% endblock %}
