{% extends "base.html" %}
{% block title %}Adquisición — Insights{% endblock %}

{% block content %}

<div class="d-flex align-items-center justify-content-between mb-3">
  <h4 class="mb-0"><i class="bi bi-bullseye text-success me-2"></i>Adquisición — Insights</h4>
  <a class="btn btn-outline-secondary" href="{{ back_url() }}"><i class="bi bi-arrow-left me-1"></i>Volver</a>
</div>

<div class="card shadow-sm mb-3">
  <div class="card-body">
    <form method="get" class="row g-2 align-items-end">
      <div class="col-md-4">
        <label class="form-label">Generación</label>
        <select class="form-select" name="gen" id="selGen">
          <option value="">(Todas)</option>
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label">Desde</label>
        <input type="date" class="form-control" name="from" value="{{ f_from }}">
      </div>
      <div class="col-md-3">
        <label class="form-label">Hasta</label>
        <input type="date" class="form-control" name="to" value="{{ f_to }}">
      </div>
      <div class="col-md-2">
        <button class="btn btn-success w-100"><i class="bi bi-funnel me-1"></i>Aplicar</button>
      </div>
    </form>
  </div>
</div>

{# ===== KPIs ===== #}
<div class="row g-3 mb-3">
  <div class="col-md-3">
    <div class="card h-100 shadow-sm"><div class="card-body">
      <div class="small text-muted">Leads</div>
      <div class="fs-4">{{ (kpis.leads or 0) }}</div>
    </div></div>
  </div>
  <div class="col-md-3">
    <div class="card h-100 shadow-sm"><div class="card-body">
      <div class="small text-muted">Diagnósticos</div>
      <div class="fs-4">{{ (kpis.diagnosticos or 0) }}</div>
      <small class="text-muted">Ventas (diag): {{ (kpis.ventas_diag or 0) }}</small>
    </div></div>
  </div>
  <div class="col-md-3">
    <div class="card h-100 shadow-sm"><div class="card-body">
      <div class="small text-muted">Inscripciones</div>
      <div class="fs-4">{{ (kpis.inscripciones or 0) }}</div>
    </div></div>
  </div>
  <div class="col-md-3">
    <div class="card h-100 shadow-sm"><div class="card-body">
      <div class="small text-muted">ROAS</div>
      <div class="fs-4">{{ (kpis.roas or 0) | round(2) }}</div>
      <small class="text-muted">Ingreso: {{ (kpis.ingreso or 0) | mxn }} · Gasto: {{ (kpis.gasto or 0) | mxn }}</small>
    </div></div>
  </div>
</div>

{# ===== Gráficas ===== #}
<div class="row g-3 mb-3">
  <div class="col-lg-6">
    <div class="card shadow-sm h-100">
      <div class="card-header bg-white border-0"><h6 class="mb-0"><i class="bi bi-activity text-success me-2"></i>Inscripciones por día</h6></div>
      <div class="card-body"><div style="height:300px"><canvas id="chartSerie"></canvas></div></div>
    </div>
  </div>
  <div class="col-lg-6">
    <div class="card shadow-sm h-100">
      <div class="card-header bg-white border-0"><h6 class="mb-0"><i class="bi bi-collection text-success me-2"></i>Ranking por generación</h6></div>
      <div class="card-body"><div style="height:300px"><canvas id="chartByGen"></canvas></div></div>
    </div>
  </div>
</div>

{# ===== Cruce detalle: diagnóstico + seguimiento ===== #}
<div class="card shadow-sm">
  <div class="card-header bg-white border-0 d-flex align-items-center">
    <h6 class="mb-0"><i class="bi bi-list-check text-success me-2"></i>Detalle por alumno</h6>
    <button id="btnCsvCross" class="btn btn-outline-secondary btn-sm ms-auto"><i class="bi bi-filetype-csv me-1"></i>CSV</button>
    <button id="btnTxtCross" class="btn btn-outline-secondary btn-sm ms-2"><i class="bi bi-filetype-txt me-1"></i>TXT</button>
  </div>
  <div class="card-body">
    {% if cross_rows and cross_rows|length > 0 %}
    <div class="table-responsive">
      <table class="table table-sm table-hover align-middle">
        <thead class="table-light">
          <tr>
            <th>Nombre</th><th>Correo</th><th>Teléfono</th><th>Generación</th>
            <th>Diagnóstico</th><th>Estatus venta</th><th>Fecha diag</th>
            <th>Seguimiento</th><th>Fecha seg</th>
          </tr>
        </thead>
        <tbody>
          {% for r in cross_rows %}
          <tr>
            <td>{{ r.nombre or '—' }}</td>
            <td>{{ r.correo or '—' }}</td>
            <td>{{ r.telefono or '—' }}</td>
            <td>{{ r.generacion or '—' }}</td>
            <td>
              {% if r.estatus_viable %}
                <span class="badge
                  {% if r.estatus_viable=='VIABLE' %}text-bg-success
                  {% elif r.estatus_viable=='REQUIERE AJUSTE' %}text-bg-warning
                  {% elif r.estatus_viable=='NO VIABLE' %}text-bg-danger
                  {% else %}text-bg-secondary{% endif %}">
                  {{ r.estatus_viable }}
                </span>
              {% else %}<span class="text-muted">Sin diagnóstico</span>{% endif %}
            </td>
            <td>{{ r.estatus_venta if r.estatus_venta is not none else '—' }}</td>
            <td>{{ (r.fecha_diag|string)[:16] if r.fecha_diag else '—' }}</td>
            <td>
              {% if r.estado_seg %}
                <span class="badge
                  {% if r.estado_seg=='contactado' %}text-bg-info
                  {% elif r.estado_seg=='en_proceso' %}text-bg-warning
                  {% elif r.estado_seg=='cerrado' %}text-bg-success
                  {% else %}text-bg-secondary{% endif %}">
                  {{ r.estado_seg.replace('_',' ') }}
                </span>
              {% else %}<span class="text-muted">—</span>{% endif %}
            </td>
            <td>{{ (r.fecha_seg|string)[:16] if r.fecha_seg else '—' }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="text-muted">Sin registros para el filtro.</div>
    {% endif %}
  </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(function(){
  // Rellenar select de generaciones (ya tienes /api/generaciones)
  const current = {{ gen|tojson }};
  fetch('/api/generaciones').then(r=>r.json()).then(list=>{
    const sel = document.getElementById('selGen');
    list.forEach(g=>{
      const opt = document.createElement('option');
      opt.value = g; opt.textContent = g;
      if (current && current===g) opt.selected = true;
      sel.appendChild(opt);
    });
  });

  // Serie de inscripciones
  const sLabels = {{ (series_labels or []) | tojson }};
  const sData   = {{ (series_insc or []) | tojson }};
  const elS = document.getElementById('chartSerie');
  if (elS && sLabels.length) {
    new Chart(elS.getContext('2d'), {
      type: 'line',
      data: { labels: sLabels, datasets: [{ label:'Inscripciones', data:sData, borderWidth:2, tension:.2, fill:false }] },
      options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:false } }, scales:{ x:{ ticks:{ maxTicksLimit:12 } } } }
    });
  }

  // Ranking por generación (ROAS como tooltip)
  const byGen = {{ (by_gen or []) | tojson }};
  const gLabels = byGen.map(r => r.generacion || '—');
  const gInsc   = byGen.map(r => r.inscripciones || 0);
  const elG = document.getElementById('chartByGen');
  if (elG && gLabels.length) {
    new Chart(elG.getContext('2d'), {
      type: 'bar',
      data: { labels:gLabels, datasets:[{ label:'Inscripciones', data:gInsc, borderWidth:1 }] },
      options: {
        indexAxis:'y', responsive:true, maintainAspectRatio:false,
        plugins:{ legend:{display:false}, tooltip:{ callbacks:{ afterBody: (ctx)=> {
          const i = ctx[0].dataIndex, r = byGen[i];
          const roas = (r.roas ?? 0).toFixed(2);
          const ing  = (r.ingreso ?? 0).toLocaleString('es-MX',{style:'currency',currency:'MXN'});
          const gas  = (r.gasto ?? 0).toLocaleString('es-MX',{style:'currency',currency:'MXN'});
          return [`ROAS: ${roas}`, `Ingreso: ${ing}`, `Gasto: ${gas}`];
        } } } },
        scales:{ x:{ beginAtZero:true } }
      }
    });
  }

  // Export CSV/TXT del cruce
  const rows = {{ (cross_rows or []) | tojson }};
  const esc = (v)=> {
    const s = (v ?? '').toString();
    return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
  };
  const toCsv = (arr)=> arr.map(r=>r.map(esc).join(',')).join('\n');
  const dl = (name, mime, content)=> {
    const blob = new Blob([content], {type:mime}); const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download=name; document.body.appendChild(a); a.click();
    URL.revokeObjectURL(url); a.remove();
  };
  document.getElementById('btnCsvCross')?.addEventListener('click', ()=>{
    const head = ['correo','nombre','telefono','generacion','estatus_viable','estatus_venta','fecha_diag','estado_seg','fecha_seg'];
    const body = rows.map(r => [r.correo,r.nombre,r.telefono,r.generacion,r.estatus_viable,r.estatus_venta,r.fecha_diag||'',r.estado_seg||'',r.fecha_seg||'']);
    dl('adquisicion_cruce.csv','text/csv;charset=utf-8', toCsv([head, ...body]));
  });
  document.getElementById('btnTxtCross')?.addEventListener('click', ()=>{
    const lines = [];
    rows.forEach(r=>{
      lines.push(`${r.nombre||'—'} <${r.correo||'—'}> [${r.generacion||'—'}]`);
      lines.push(`  Tel: ${r.telefono||'—'}`);
      lines.push(`  Diagnóstico: ${r.estatus_viable||'—'} | Venta: ${r.estatus_venta ?? '—'} | Fecha: ${r.fecha_diag||'—'}`);
      lines.push(`  Seguimiento: ${r.estado_seg||'—'} | Fecha: ${r.fecha_seg||'—'}`);
      lines.push('');
    });
    dl('adquisicion_cruce.txt','text/plain;charset=utf-8', lines.join('\n'));
  });
})();
</script>
{% endblock %}
