{% extends "base.html" %}
{% block title %}Programas - Mi Mentor{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-success text-white">
      <h4 class="mb-0"><i class="bi bi-boxes me-2"></i>Programas - Mi Mentor de Inversión</h4>
    </div>
  </div>

  <div class="table-responsive" id="tablaProgramas"></div>
</div>

<script>
  // Encabezados amigables (igual que tu versión)
  const headersAmigables = {
    "ID_PROGRAMA": "ID Programa",
    "NOMBRE_PROGRAMA": "Nombre Programa",
    "NOMENCLATURA": "Nomenclatura",
    "DESCRIPCION": "Descripción",
    "SKU_PRODUCTO": "SKU Producto",
    "EMBUDO": "Embudo"
  };
</script>
{% endblock %}

{% block scripts %}
<script>
// Carga condicional de DataTables + Buttons si no existen
function ensureCss(href) {
  if (![...document.styleSheets].some(s => s.href && s.href.includes(href))) {
    const l = document.createElement('link');
    l.rel = 'stylesheet'; l.href = href;
    document.head.appendChild(l);
  }
}
function ensureScript(src) {
  return new Promise((resolve, reject) => {
    if ([...document.scripts].some(s => s.src && s.src.includes(src))) return resolve();
    const el = document.createElement('script');
    el.src = src; el.onload = resolve; el.onerror = reject;
    document.body.appendChild(el);
  });
}

(async function init(){
  // CSS (por si base.html no lo trae)
  ensureCss('https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css');
  ensureCss('https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css');

  // jQuery + DataTables (si no están)
  if (!(window.$ && window.jQuery)) {
    await ensureScript('https://code.jquery.com/jquery-3.7.1.min.js');
  }
  if (!(window.$ && $.fn && $.fn.DataTable)) {
    await ensureScript('https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js');
  }
  if (!(window.$ && $.fn && $.fn.dataTable && $.fn.dataTable.Buttons)) {
    await ensureScript('https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js');
    await ensureScript('https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js');
    await ensureScript('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/pdfmake.min.js');
    await ensureScript('https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js');
    await ensureScript('https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js');
    await ensureScript('https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js');
  }

  cargarProgramas();
})();

function cargarProgramas() {
  $('#tablaProgramas').html('<div class="text-center text-muted py-4"><div class="spinner-border text-success" role="status"><span class="visually-hidden">Cargando...</span></div><br>Cargando programas...</div>');

  $.ajax({
    url: "{{ url_for('api_programas') }}",
    method: "GET",
    success: function(data) {
      if (data.error) {
        $('#tablaProgramas').html('<div class="alert alert-danger">Error: ' + data.error + '</div>');
        return;
      }

      // después de EMBUDO en `columnas`
      const columnas = ["ID_PROGRAMA","NOMBRE_PROGRAMA","NOMENCLATURA","DESCRIPCION","SKU_PRODUCTO","EMBUDO","__ACCION__"];

      let thead = '<thead><tr>';
      columnas.forEach(col => thead += `<th>${headersAmigables[col] || col}</th>`);
      thead += '</tr></thead>';

      let tbody = '<tbody>';
      (data || []).forEach(row => {
        tbody += '<tr>';
        (columnas || []).forEach(col => {
          if (col === "__ACCION__") {
            const nextParam = encodeURIComponent(window.location.href);
            const id = encodeURIComponent(String(row.ID_PROGRAMA || ""));
            const href = `/programa/${id}?next=${nextParam}`;
            tbody += `<td class="text-nowrap">
              <a href="${href}" class="btn btn-sm btn-outline-primary">Ver</a>
            </td>`;
            return; // saltamos al siguiente col
          }
          let valor = (row[col] ?? '');
          tbody += `<td>${valor}</td>`;
        });
        tbody += '</tr>';
      });
      tbody += '</tbody>';


      const tableHTML = `
        <table id="programasTable" class="table table-sm table-hover table-striped table-bordered align-middle text-nowrap w-100">
          ${thead}
          ${tbody}
        </table>`;

      if ($.fn.DataTable.isDataTable('#programasTable')) {
        $('#programasTable').DataTable().clear().destroy();
      }

      $('#tablaProgramas').html(tableHTML);

      $('#programasTable').DataTable({
        scrollX: true,
        scrollY: '400px',
        scrollCollapse: true,
        pageLength: 50,
        lengthMenu: [[25, 50, 100], [25, 50, 100]],
        autoWidth: false,
        responsive: false,
        dom: '<"d-flex justify-content-between align-items-center mb-2"lfB>rt<"d-flex justify-content-between mt-2"ip>',
        order: [[1, 'asc']],
        buttons: ['copy', 'csv', 'excel', 'pdf', 'print'],
        language: {
          search: "Buscar:",
          lengthMenu: "Mostrar _MENU_ registros por página",
          zeroRecords: "No se encontraron resultados",
          info: "Mostrando _START_ a _END_ de _TOTAL_ registros",
          infoEmpty: "Mostrando 0 a 0 de 0 registros",
          infoFiltered: "(filtrado de _MAX_ registros totales)",
          paginate: { first: "Primero", last: "Último", next: "Siguiente", previous: "Anterior" }
        },
        initComplete: function () { this.api().columns.adjust(); }
      });
    },
    error: function(err) {
      $('#tablaProgramas').html('<div class="alert alert-danger">Error al cargar datos.</div>');
      console.error("Error al cargar programas:", err);
    }
  });
}
</script>
{% endblock %}
