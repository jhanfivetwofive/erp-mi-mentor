<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generaciones - Mi Mentor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body class="bg-light">

    <!-- Barra de navegación -->
    <nav class="navbar navbar-expand-lg navbar-light bg-success">
        <div class="container mt-4">
            <a class="navbar-brand text-white" href="#">Mi Mentor de Inversión</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link text-white" href="/">Inicio</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white" href="/alumnos">Alumnos</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white" href="/catalogo/programas">Programas</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white" href="/catalogo/generaciones">Generaciones</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link text-white" href="/logout">Cerrar sesión</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

<div class="container mt-4">
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-success text-white">
            <h4 class="mb-0"><i class="bi bi-people-fill me-2"></i>Generaciones - Mi Mentor de Inversión</h4>
        </div>
    </div>

    <div class="table-responsive" id="tablaGeneraciones"></div>
</div>

<script>
const headersAmigables = {
    "ID_GENERACION_PROGRAMA": "ID Generación Programa",
    "PROGRAMA": "Programa",
    "GENERACION": "Generación",
    "GENERACION_ETIQUETA": "Etiqueta Generación",
    "FECHA_INICIO": "Fecha Inicio",
    "FECHA_FIN": "Fecha Fin",
    "PRECIO_GENERACION": "Precio Generación",
    "DESCRIPCION": "Descripción"
};
</script>

<script>
function cargarGeneraciones() {
    $('#tablaGeneraciones').html('<div class="text-center text-muted py-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Cargando...</span></div><br>Cargando generaciones...</div>');

    $.ajax({
        url: "/api/catalogo/generaciones",
        method: "GET",
        success: function(data) {
            if (!Array.isArray(data) || data.length === 0) {
                $('#tablaGeneraciones').html('<div class="alert alert-warning">No se encontraron generaciones.</div>');
                return;
            }

            let columnas = ["ID_GENERACION_PROGRAMA", "PROGRAMA", "GENERACION", "GENERACION_ETIQUETA", "FECHA_INICIO", "FECHA_FIN", "PRECIO_GENERACION", "DESCRIPCION"];

            let thead = '<thead><tr>';
            columnas.forEach(col => thead += `<th>${headersAmigables[col] || col}</th>`);
            thead += '</tr></thead>';

            let tbody = '<tbody>';
            data.forEach(row => {
                tbody += '<tr>';
                columnas.forEach(col => {
                    let valor = row[col] ?? '';
                    if (col.includes("FECHA") && valor) {
                        try {
                            let fecha = new Date(valor);
                            if (!isNaN(fecha)) {
                                valor = fecha.toISOString().split('T')[0]; // Formato: YYYY-MM-DD
                            }
                        } catch (e) {
                            // Si falla, deja el valor como está
                        }
                    }
                    tbody += `<td>${valor}</td>`;
                });
                tbody += '</tr>';
            });
            tbody += '</tbody>';

            const tableHTML = `
                <table id="generacionesTable" class="table table-sm table-hover table-striped table-bordered align-middle text-nowrap">
                    ${thead}
                    ${tbody}
                </table>`;

            // Reinicializa DataTable si ya existe
            if ($.fn.DataTable.isDataTable('#generacionesTable')) {
                $('#generacionesTable').DataTable().clear().destroy();
            }

            $('#tablaGeneraciones').html(tableHTML);

            $('#generacionesTable').DataTable({
                scrollX: true,
                scrollY: '400px',
                scrollCollapse: true,
                pageLength: 50,
                lengthMenu: [[25, 50, 100], [25, 50, 100]],
                autoWidth: false,
                dom: '<"d-flex justify-content-between align-items-center mb-2"lfB>rt<"d-flex justify-content-between mt-2"ip>',
                buttons: ['copy', 'csv', 'excel', 'pdf', 'print'],
            });

        },
        error: function(err) {
            $('#tablaGeneraciones').html('<div class="alert alert-danger">Error al cargar datos.</div>');
            console.error("Error al cargar generaciones:", err);
        }
    });
}


$(document).ready(function() {
    cargarGeneraciones();
});
</script>

</body>
</html>
